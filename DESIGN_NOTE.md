# TinySeqデザインノート

[MOTIVATION.md](MOTIVATION.md)でTinySeqの背景を簡単に説明した。ここでは、システムとしてのTinySeqの要件、概要仕様、実装上の留意点を中心に説明する。

# 前提とするイメージ

* マイクロコントローラ(PIC32MX, Raspberry Pi Pico等)を使い、シーケンサを実現する。
* ラダープログラムをテキスト(ASCIIアート風に)で記述し、それをFORTHワードとして解釈実行する
* シーケンサとしては基本レベル、IN16点、OUT16点、途中デバイス16個程度。
* 端子が足りないときはI/O Expanderを使う。1個でIN8点、OUT8点を担当できる。
* マイクロコントローラのクロックは40MHz程度、サイクルタイムは10ms程度。FLASHは32kB, RAMは8kB程度。

# 要件

## システム

* 制御盤からの24Vで動作すること
* IN 18点以上、OUT 12点以上に対応すること。
　(このシーケンサで実現したいシステムとして、IN16点では足りないことが分かっている)
* 機械に取り付けた状態で、ノートPCからUSBシリアルケーブルを接続してラダープログラム・ファームウェアを更新できること。

## ハードウェア

### コントローラI/O側とマイクロコントローラI/Oの間をアイソレートすること

IN/OUT端子はすべてフォトカプラを介してマイクロコントローラと接続する。コントローラ側は24V電流駆動(電流ON==1, 電流OFF==0)、OUT側は、コントローラのIN端子に接続する。

* コントローラのIN端子もフォトカプラでシンク側(グランドがCOMMON端子でシーケンサ側に出ている)のため、TinySeq側はソース側(フォトカプラ出力トランジスタのプラス側を24V側に接続する)とする。電流制限抵抗はコントローラ側に内蔵されているので、フォトカプラのマイナス側はTinySeqのOUT端子に直結する。
* コントローラのOUT端子はソース側になる。TinySeqのIN端子は電流制限抵抗(2.7kΩ)を介してフォトカプラの入力LEDを経てGNDにつながれる。

### マイクロコントローラ側電源も、24V側から受ける場合と、24V側とアイソレートした状態と両方存在する。

* スタンドアロンで動く→24V側から供給(DC-DCコンバータで降圧して供給)
* PCとシリアル接続(ラダープログラム開発時)→24V側から供給
* ファーム書き換え→24V側とアイソレート、PC側(MPLAB SNAP側)から電源供給

基板構成を、CPU基板とフォトカプラ基板の2つとする。24Vはフォトカプラ基板に供給し、フォトカプラのコントローラ側で24V, GNDの電流駆動前提、CPU基板側はVcc(3.3V または5V)の電圧駆動とする。

CPUへの給電は、24V側からの降圧と、外部USBシリアルからの2つにする。外部USBシリアルからの給電は、ファームウェア書き込みの時に行い、このとき、GND含め24V側と切り離す。

24Vからの降圧電源で駆動されているときでも、絶縁USBシリアル経由でPCと接続できること。ファームウェアの更新はできないが、ラダープログラムの書き換えはできる。

### 基板構成

フォトカプラ基板: 24V給電を受ける。フォトカプラの24V側とCPU側とはアイソレートできる。通常は24V側とCPU側は結合しておりCPUはアイソレートされない。アイソレートはジャンパ2本で行う。ジャンパ2本を外すことで、CPU基板のVCC, GNDは24V側GNDと切り離される。フォトカプラのCOMグランドは常時CPU基板のGNDと接続されている。24V側のI/O信号を接続する 2x7ピンヘッダ2本経由で外部デバイス(コントローラ)を制御する。

CPU基板: CPU, I/O Expander, EEPROMを搭載している。フォトカプラ基板とは2x20pinでデジタルI/Oを接続し、2x8pin(のうち2本)で電源(5V or 3.3V)の供給を受ける。CPU基板には、MPLAB SNAP接続用の1x6pinピンソケットと、絶縁シリアル接続用の1x6pinピンソケットがある。

## ソフトウェア

FORTH処理系の上に、ラダープログラム用のワードを定義する。この状態で辞書をFLASH/EEPROMに保存しておき、以後はこの保存された辞書を自動時にRAM上に展開して実行を開始する。

FORTH処理系とシステムとの間のインタフェースは以下の関数で行う。

### シリアルIN/OUT:
```
void init_uart(void);
int _mon_get(void);
void _mon_put(int c);
```
シリアル初期化、1バイトRead/Writeの各関数を用意する。マイクロコントローラ依存である。

### I2c
```
void i2c_init(void);
```
I2Cコントローラを初期化する。100k/400kは実装依存、どちらでもよい。

```
void i2c_idle(void);
```
バスがアイドルになるまで待つ。送受信完了待ち、ACK待ちのいずれもそうでない場合まで待つ。
```
int i2c_write(unsigned char data);
```
I2Cバスに1バイトデータを送信する。デバイスアドレスを送信するときは、上位7ビットがアドレスで、最下位ビットはRead/Writeビットとなる。

デバイスからACKを受けると0、NACKを受けると-1を返す。

```
int i2c_start(uint8_t dev_addr);
```
デバイスにアドレスを送信し、トランザクションを開始する。デバイスが存在しない場合、NACKを返す(というより、誰も応答しないからデータ線が1のままでNACKと解釈される)。デバイスから応答がある場合は0を返すので、2バイト目以後をi2c_writeを使って送信することができる。

### I/O Expander

I2C接続のMCP23017用のドライバを用意している。上記のi2c関数を使って実装されている。

