# TinySeq ... 簡易シーケンサ

TinySeqは単純なシーケンサです。ラダー形式で記述したプログラムを定期的に実行し、デジタル入力の変化に応じてデジタル出力を制御します。

TinySeqは PIC32MX, ATmega386, Raspberry Pi Picoを用いて簡易シーケンサを実現できるように考えて作りました。C言語で記述されており、ANSI Cコンパイラがある環境ならばコード20kB程度、RAM 4kB程度があれば実行できるようにすることを目標として実装しました。

シーケンサが実行する「プログラム」(ラダーと言います)をテキストとして記述し、シリアルポートから流し込めば実行開始できます。

テキスト形式で簡単な言語を解釈実行でき、かつコンパクトに実現するために、FORTHインタプリタをベースにしました。
`zForth`(https://github.com/zevv/zForth)をベースとし、システムコールとしてプリミティブを拡張する機能を用いてラダーを構成する部品を実現しています。
独自のprintf関数(Chanさんのxprintf)を持ち、コードが不用意に膨らまないように配慮しました。

## シーケンサとは何か

シーケンサとは、複数の入力端子と出力端子を持ち、スイッチとリレーを組み合わせて回路を構成することで実現します。リレーとは、コイルとスイッチから成り、コイルに通電するとスイッチが切り替わる機能を持つデバイスです。

> 三菱電機やオムロンから売り物の(まともな)シーケンサが出ています。PLC(Programmable Logic Controller)とも言います。プロはまともなものを買って使うのですが、仕事でI/O制御が必要になり、シーケンサを調べてみて、これなら作ってみてもできそうだということで作ってみることにしました。

例えば、以下の回路は、入力端子 X000 をONにするとリレー M000のコイルに通電され、リレーM000のスイッチの状態が反転し、X000をOFFにしてもM000の通電が継続する回路です(自己保持回路)。
```
|- X000.a --
|- M000.a -- 2+ M000 -|
```
まず、左端の`|-`はプラス電源(通常、24V)、右端の`-|`　はマイナス電源を表します。両端にプラスマイナス電源を置き、その間にスイッチとリレーの回路を作るというわけです。

X000は入力端子に直結しているスイッチです。入力端子0がONになると、スイッチX000がONになると考えます。

スイッチは、「押すとONになるスイッチ」と「押すとOFFになるスイッチ」がペアで存在すると考えます。前者をa端子、後者をb端子と呼び、X000.a, X000.b と書きます。

リレーのスイッチは、「通電するとONになるスイッチ」「通電するとOFFになるスイッチ」があり、それぞれM000.a, M000.bと書きます。

上図の回路では、スイッチX000, M000が並列で接続され(`2+`が、それまでの開き線2本を接続するポイントを表します)、その先にリレーM000のコイルが接続されています。よって、X000が導通すると、(M000のONOFFに関わらず)リレーM000のコイルに電流が流れ、その結果M000のスイッチがONになり、以後、X000がOFFになってもリレーM000のON状態が継続します。これをもって自己保持回路というわけです。

ラダー形式はFORTH言語に皮をかぶせた形式で記述します。`|-`, `X000.a`, `--`, `M000.a`, `2+`,  `M000`, `-|` は全てFORTH言語の「ワード」です。FORTH言語は空白文字(スペース, ` `, 0x20)で区切られた単語を「ワード」とよび、「ワード」それぞれが内部的なサブルーチン呼び出しを表すと考えてください。標準のFORTH言語にはこれらのワードは定義されていません。TinySeqの中で、シーケンサを記述するためのこれらのワードが定義されています。

ラダーを構成する要素には以下のものがあります。

* Xnnn: 入力スイッチ。入力端子0の状態がそのままスイッチX000のON/OFFに反映される。
* Ynnn: 出力リレー。Y000のコイルの通電状態がそのまま出力端子0の状態になる。リレー端子はYnnn.a, Ynnn.bであり、リレーの状態を別のLINEで参照することができる。
* Mnnn: 内部リレー。入出力端子と直結していない、内部に存在するリレーで、端子Mnnn.a, Mnnn.bを持つ。
* Nnnn: ON-Delayリレー。通電開始後、引数で指定した時間後にONとなる。
* Fnnn: OFF-Delayリレー。通電開始直後にOFFとなり、引数で指定した時間後にOFFとなる。

スイッチのAND/OR論理回路に、自己保持回路で状態を保持し、ON-Delay/OFF-Delayリレーでタイマーと順序回路を構成するという感じでしょうか。数値演算を使わない(プロ用のシーケンサは数値演算も書けるようですが、……何に使うんだろうか?)、制御構造が存在しないので、プログラムと言っても論理回路の方が近いイメージだと思います。
