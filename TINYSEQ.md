# TinySeq仕様書

## TinySeqとは

TinySeqはシンプル(単純、簡単)なシーケンサです。ラダー形式で記述したプログラムを定期的に実行し、デジタル入力の変化に応じてデジタル出力を制御します。

シーケンサが実行する「プログラム」(`ラダー`と言います)をテキストとして記述し、シリアルポートから流し込めば実行開始できます。

シーケンサが実行するアプリケーションは、複数の入力端子と出力端子を持ち、スイッチとリレーを組み合わせて回路を構成することで実現されます。リレーとは、コイルとスイッチから成り、コイルに通電するとスイッチが切り替わる機能を持つデバイスです。スイッチとリレーを組み合わせ構成される回路を記述したものが`ラダー`です。

### ラダーの例

本シーケンサが実行可能な回路の例を以下にあげます。

```
|- X000.a -|1
|- M000.a -|1- M000 -|
```

X000.a はスイッチです。M000はリレーのコイルを表します。左端と右端の間に電圧をかけた状態で、スイッチX000を押すと、X000.aが導通します。X000.aの右側の端子はリレーM000に接続されているので、M000に電流が流れコイルに磁力が生まれ、リレーM000の接点がONになります。

M000.a はリレーの接点(contact)です。リレーM000のコイルに電流が流れるとONになります。M000.aの他方の端子もリレーM000に接続されているので、スイッチX000から手を放しても、コイルM000には電流は流れ続け、接点M000はON状態を継続します。こうして、一度X000を押すと、以後リレーM000は導通を続ける回路であることがわかります(自己保持回路)。

## TinySeqシステム

マイコン基板上で動作することを想定しています。

GPIO(またはIO Expander)により、外部回路の状態を入力できます。また、外部回路に対して1/0信号を出力できます。

用途・目的は、外部回路の状態入力に応じて、出力端子の出力で外部回路をコントロールすることです。

コントロールは、ユーザが定義するラダープログラムの実行により行います。システムにラダープログラムを登録すると、それは一定時間(例えば10ms)に1回定期的に呼び出されます。

> 実装上は、入力端子の状態が変化するか、On Delay/Off Delayリレーの状態変化を検知した際に1回呼び出されます。

非常停止入力(入力端子)を持ちます。非常停止入力をLにすると、システムは非動作状態(ラダーの実行を停止)し、すべての出力をOFF(出力端子を0)にします。

シリアルコンソールを持ちます。Teraterm等の端末エミュレータを接続して使用します。ラダープログラムの登録、コマンドの実行、デバッグ(実行状態ダンプなどのログ出力機能があります)に使用できます。

## ラダープログラム

ラダープログラムは、スイッチとリレー(コイルと接点)を組み合わせた回路として表現します。1回の実行で上・左から下・右の順にシーケンシャルに実行します。実行はタイマにより定期的に行われます。1回の実行により、ラダープログラムが複数回実行されることがあります。ラダープログラム1回の実行で、リレーの状態・出力端子の状態に変化がなくなるまでラダープログラムが実行されます。

## 構成要素

ラダープログラムは、スイッチ、リレーと補助的端子の結合により表現できます。

### スイッチ

スイッチは`Xnnn.a` または`Xnnn.b`で表します。入力端子が1になっているとき、スイッチはONになります。
スイッチは「normally on」のものと、「normally off」のものがあります。前者はX000.a、後者はX000.bのように、dot a, dot bを後ろにつけます(a接点、b接点)。

### リレー

リレーはコイルと接点からなります。リレーには以下の４種類があります。

* 通常のリレー、コイル: Mnnn、接点: Mnnn.a, Mnnn.b
* 出力リレー、コイル: Ynnn (接点はありません)
* ON-Delayリレー、Nnnn、接点: Nnnn.a, Nnnn.b
* OFF-Dekayリレー、Fnnn、接点: Fnnn.a, Fmmm.b

コイル名の後ろに、`.a`, `,b`を付けることでa接点、b接点を表します。

### 通常のリレー

非通電時にa接点はOFF、b接点はONになります。通電時は逆で、a接点はON、b接点はOFFになります。

### 出力リレー

出力端子に直結しているリレーで、コイルに通電すると、対応する出力端子が1になります。接点がないことが建前ですが、実際には、ラダー中でa接点、b接点を記述することができます。

### ON Delayリレー

コイルに通電すると、通電直後はOFFのままで、一定時間後に端子がONになる特殊なリレーです。ONになるまでの間に通電がとだえると待ち時間のタイマはクリアされ、再度通電が始まってから改めてカウントダウンが始まります。コイルはNnnn, 端子は Nnnn.a, Nnnn.bで表します。

### OFF Delayリレー

コイルに通電すると即座にONになりますが、一定時間後に自動的にOFFになる特殊なリレーです。カウントダウン満了前に通電がとだえると、その時点でOFFになります。

### 補助的構成要素

＋電源、グランド、複数部品を1つにまとめる中間端子があります。

## ラダーの記述方法

FORTHの構文の上に作っている。文法としては、空白で区切られたワードの連なり、だけである。以下、使用できるワードを、FORTH風のワード定義として説明してゆく。

値`true`はゼロ以外の値(多くはall bit zeroですが、いずれかのビットが立っていればtrueとして扱われます)、`false`はゼロを表します。

`nnn`は数字3桁を表す。省略表記は認めず、常に3桁(上位桁は'0')で記述する。

### Xnnn.a, Ynnn.a, Mnnn.a, Nnnn.a, Fnnn.a

a接点を表す。
```
val Xnnn.a --> val'
```
入力端子の状態を表すスイッチ。入力端子が1のときONとなり、0のときOFFとなる。

スタックから値を1つ読み取り、その値がtrueかつスイッチがONであるときのみ値trueをスタックに置く。他の場合は値falseをスタックに置く。
```
val Ynnn.a --> val'
```
出力端子の状態を表すスイッチ。ラダープログラム内で出力状態を参照したい場合に用いる。出力端子が1のときON, 0のときOFFとなる。

スタックから値を1つ読み取り、その値がtrueかつスイッチがONであるときのみval'としてtrueをスタックに置く。他の場合は`false`をスタックに置く。

```
val M000.a --> val'
```



配線部材的なパーツも定義している。